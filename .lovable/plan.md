
## تشخيص نهائي (لماذا ما زال يفشل)
من سجلات الشبكة الظاهرة عندك، الطلبات تذهب إلى:
`https://...lovableproject.com/functions/v1/backend-proxy/...`
وتعود **404**.

هذا يعني أن **المتصفح لا يصل أصلًا إلى وظيفة “backend-proxy”**. لذلك مكتبة المصادقة تتوقع JSON لكنها تستلم استجابة فارغة/404 → يظهر الخطأ:
“Unexpected end of JSON input”.

كما أن عدم وجود أي Logs للوظيفة `backend-proxy` في الخلفية يؤكد أنها **لم تُستدعَ إطلاقًا**.

السبب: مسار `/functions/v1/...` على دومين المعاينة داخل المحرر (`lovableproject.com`) لا يقدّم وظائف الخلفية بهذا الشكل، لذلك يعيد 404.

## الهدف من التعديل القادم
نجعل استدعاء البروكسي يذهب إلى مكان “مضمون” يستضيف وظائف الخلفية فعلًا، وهو:
`VITE_SUPABASE_URL/functions/v1/backend-proxy/...`
بدلًا من `window.location.origin/functions/v1/...`.

مهم: هذا لا يتطلب دومين خاص. هو مجرد تغيير “عنوان” استدعاء الوظيفة.

## التغيير الأساسي المطلوب (تصحيح إعادة الكتابة)
سنعدّل `src/lib/installBackendProxyFetch.ts` كالتالي:

1) **تقييد ما يتم بروكسته**
حاليًا أي طلب إلى نفس أصل `VITE_SUPABASE_URL` يتم تحويله، وهذا قد يفسد استدعاءات وظائف أخرى مثل:
`.../functions/v1/shared-media-sign`

لذلك سنغيّر `shouldProxy(url)` ليعمل فقط على المسارات التالية (أو ما يعادلها):
- `/auth/` (تسجيل/دخول/تحديث توكن)
- `/rest/` (استعلامات قاعدة البيانات)
- `/storage/` (الملفات)
- (اختياري) `/graphql/` إن كانت مستخدمة

وسنستثني تمامًا:
- `/functions/v1/` (حتى لا نكسر وظائف أخرى ولا ندخل في دوائر)

2) **تغيير وجهة البروكسي**
بدل:
`${window.location.origin}/functions/v1/backend-proxy...`

نستخدم:
`${SUPABASE_URL}/functions/v1/backend-proxy...`

وبالتالي يصبح المثال:
- من: `https://<project>.supabase.co/auth/v1/token?...`
- إلى: `https://<project>.supabase.co/functions/v1/backend-proxy/auth/v1/token?...`

بهذا نحن نستدعي وظيفة الخلفية مباشرة من مسار الوظائف الصحيح (بدون الاعتماد على دومين المحرر).

3) **إضافة حماية لمنع إعادة البروكسة لنفس طلب البروكسي**
حتى لو حدثت حالة نادرة، سنضيف شرطًا بسيطًا:
- إذا كان المسار يحتوي `/functions/v1/backend-proxy/` لا نعيد كتابته مرة أخرى.

## تحسينات تشخيصية “مضمونة” داخل البروكسي (لتأكيد الحل بدل التخمين)
سنعدّل `supabase/functions/backend-proxy/index.ts` لإضافة endpoint صحي (Health check):

- إذا كان `targetPath === "health"`:
  - يرجع JSON مثل: `{ ok: true, time: "...", version: "..." }`

هذا يسمح لنا بالتأكد مباشرة:
- هل المتصفح قادر على استدعاء وظيفة الخلفية؟
- وهل الوظيفة تعمل وتصل للبيئة؟

## تحسين رسالة الخطأ للمستخدم بدل “كلمة المرور خاطئة”
حاليًا صفحة Auth تُظهر رسالة “بيانات غير صحيحة” لحماية الخصوصية، لكن في وضعنا الحالي هذا يخفي مشاكل الاتصال.

سنضيف في `src/pages/Auth.tsx` منطقًا:
- إذا ظهرت أخطاء من نوع JSON parse/Unexpected end أو status 404/502 من البروكسي:
  - نعرض رسالة واضحة: “فشل الوصول لخدمة المصادقة (Proxy)” بدل “بيانات خاطئة”
  - ونُبقي رسالة “بيانات خاطئة” فقط عندما يكون الرد من المصادقة فعليًا (مثل 400/401 مع JSON صالح)

## خطوات اختبار بعد التنفيذ (مهمة جدًا لتأكيد النجاح بسرعة)
1) افتح `/auth` وجرب تسجيل الدخول بـ:
   - `testuser12345@test.com`
   - `password123`

2) إذا فشل:
   - سننفذ طلب تشخيصي واحد من الواجهة إلى:
     - `.../functions/v1/backend-proxy/health`
   - إن نجح → البروكسي يعمل ونتجه لمشكلة أخرى (مثل قيود شبكة تمنع حتى وظائف الخلفية أو إعدادات auth)
   - إن فشل → المشكلة ليست حساب/كلمة مرور إطلاقًا، بل منع اتصال شامل بـ `supabase.co` على جهازك/شبكتك، وسنحتاج مسار بديل (مثل نشر المشروع واستخدام دومين المعاينة `lovable.app` إن كان يسمح بالوصول عبره، أو تقديم خيار تسجيل عبر مزود OAuth يعمل عبر نافذة خارجية).

## الملفات التي سنعدّلها
- `src/lib/installBackendProxyFetch.ts`
  - تقييد shouldProxy + تغيير rewriteUrl + منع بروكسة /functions/v1
- `supabase/functions/backend-proxy/index.ts`
  - إضافة مسار health
- `src/pages/Auth.tsx`
  - تحسين تشخيص الأخطاء بحيث لا تظهر “بيانات خاطئة” عند أخطاء proxy/شبكة

## لماذا هذه الخطة “جذرية” فعلًا
لأننا نزيل سبب 404 نهائيًا:
- بدل الاعتماد على مسار غير موجود على دومين المحرر (`/functions/v1` على lovableproject.com)
- سنستدعي وظيفة الخلفية من مسارها الصحيح الذي نعلم أنه موجود فعلًا.

وبعدها سنحصل على نتيجة قطعية:
- إمّا يبدأ تسجيل الدخول/التسجيل بالعمل
- أو نثبت أن شبكتك تمنع حتى الوصول لدومين الخلفية نفسه، وحينها نختار مسار دخول بديل مناسب (OAuth/نشر/دومين معاينة مختلف).

