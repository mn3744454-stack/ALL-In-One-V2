
## إعادة صياغة المشكلة (بدقة)
أنت ما زلت ترى:
- رسالة “فشل في تحميل النتائج”
- وواجهة “لا توجد نتائج”

وبنفس الوقت سجلات قاعدة البيانات ما زالت تُظهر الخطأ:
`operator does not exist: text = uuid`

هذا يعني أن الإصلاح السابق لم يُغطِّ كل المواضع التي فيها مقارنة UUID بطريقة خاطئة داخل دوال الصلاحيات/المشاركة، وبالتالي استعلام `lab_results` يفشل بالكامل قبل أن يعيد أي بيانات.

---

## ما اكتشفته الآن (السبب الحقيقي لاستمرار المشكلة)
يوجد **نسختان** من الدالة `public.can_access_shared_resource` بتواقيع (signatures) مختلفة:

1) نسخة “المشاركة/المنح” المستخدمة فعليًا داخل سياسة RLS على جدول `lab_results`، ويتم استدعاؤها هكذا داخل الـ policy:
```sql
can_access_shared_resource(auth.uid(), 'lab_results', id, 'read')
```

وهذه النسخة (بتوقيع):
`(_actor_user_id uuid, _resource_type text, _resource_id uuid, _required_access text)`
ما زالت تحتوي على السطر الخاطئ:
```sql
_resource_id::text = ANY(g.resource_ids)
```

2) نسخة أخرى بتوقيع:
`(_tenant_id uuid, _resource_type text, _resource_id uuid)`
وهي التي تم إصلاحها سابقًا (أو جزء منها)، لكنها ليست التي تُستخدم في سياسة `lab_results`.

لهذا السبب: حتى بعد إصلاح النسخة الثانية، بقيت سياسة `lab_results` تعتمد على النسخة الأولى التي ما زالت تُنتج نفس الخطأ.

---

## حجم التغييرات على قاعدة البيانات (Scope)
التغيير المطلوب **صغير جدًا وغير تدميري**:

- لا يوجد أي تعديل على الجداول أو الأعمدة أو البيانات (0 تغييرات Schema على الجداول).
- لا تغيير على منطق الصلاحيات نفسه (RLS/المشاركة/الاتصال) من ناحية “من له الحق”.
- فقط إصلاح نوع مقارنة داخل دالة موجودة حتى لا تنهار الاستعلامات.

التغييرات الفعلية ستكون:
1) تحديث (CREATE OR REPLACE) الدالة:
   `public.can_access_shared_resource(_actor_user_id uuid, _resource_type text, _resource_id uuid, _required_access text)`
   لإزالة `::text` وجعل المقارنة UUID مع uuid[] صحيحة:
   ```sql
   _resource_id = ANY(g.resource_ids)
   ```
2) إضافة حماية بسيطة داخل الدالة: إذا كان `_actor_user_id` فارغ (NULL) ترجع `false` مباشرة (هذا مهم لأن سياسة RLS عندها role = public وقد تُقيّم مع مستخدم غير مسجل).

لا نحتاج لتعديل سياسات RLS نفسها؛ فقط إصلاح الدالة التي تعتمد عليها.

---

## لماذا هذا لا يغيّر الصلاحيات أو “المشاركة/الاتصال”؟
الدالة ستستمر في التحقق من:
- حالة الاتصال accepted
- حالة المنحة active وغير منتهية
- كون المستخدم هو المستلم أو عضو في tenant المستلم
- وأن الـ resource_id ضمن resource_ids (إن وُجدت)

نفس الشروط تمامًا، فقط بدون كسر نوع البيانات.

---

## خطوات التنفيذ (Implementation Steps)
### 1) عمل Migration تصحيحية (Idempotent)
- إنشاء ملف migration جديد يقوم بـ `CREATE OR REPLACE FUNCTION` لنفس التوقيع المستخدم في RLS.
- التأكد أن الميجريشن آمن للتكرار (إعادة التشغيل) ولا يعتمد على حذف بيانات.

### 2) التحقق بعد التطبيق
بعد تطبيق الميجريشن:
- مراقبة سجلات الأخطاء للتأكد أن `operator does not exist: text = uuid` اختفى.
- تجربة فتح صفحة النتائج مرة أخرى؛ يجب أن يختفي Toast “فشل في تحميل النتائج”.
- بما أن قاعدة البيانات تحتوي على 22 نتيجة بالفعل، يجب أن تظهر قائمة النتائج بدل “لا توجد نتائج”.

### 3) معالجة ملاحظة جانبية مهمة (تصحيح في الكود لاحقًا)
ظهر في السجل السابق أنه تم “تعديل” ملف `src/integrations/supabase/types.ts` — هذا ملف مُولّد تلقائيًا ولا يجب تعديله يدويًا.
عند الانتقال لوضع التنفيذ (Default mode) سأراجع هذا الملف وأُعيده للوضع الصحيح/المولّد تلقائيًا وفق قواعد المشروع، لأن أي تعديل يدوي عليه قد يسبب مشاكل Typescript مستقبلًا.

---

## اختبارات/حالات خاصة نتأكد منها
- مستخدم غير مسجل: يجب أن يرجع `false` بدون أخطاء.
- مستخدم عضو في نفس المؤسسة: يجب أن يمر بدون الحاجة لمسار المشاركة.
- مستخدم لديه اتصال + منحة موارد محددة: يجب أن تمر المقارنة `ANY(uuid[])` بشكل صحيح.
- مستخدم لديه منحة بدون resource_ids (NULL): يجب أن تعمل كما كانت.

---

## النتيجة المتوقعة بعد الإصلاح
- تختفي رسالة “فشل في تحميل النتائج”.
- تظهر النتائج في صفحة المختبر بدل “لا توجد نتائج” (لأن البيانات موجودة بالفعل).
- يتوقف ظهور خطأ Postgres “text = uuid” في السجلات.

---

## ما الذي سأحتاجه منك أثناء التنفيذ؟
لا شيء إضافي. فقط بعد التطبيق مباشرة:
- حدّث الصفحة (Refresh).
- افتح تب “النتائج” مرة أخرى للتأكد أن البيانات ظهرت.

