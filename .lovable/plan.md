
# إصلاح: التراجع عن التغيير الذي سبب البطء وعدم ظهور المنشأة

## سبب المشكلة
التعديل الأخير على `TenantContext.tsx` جعل الكود يبقي `loading = true` عندما لا يوجد مستخدم، بدلاً من إنهاء التحميل. هذا يسبب:
- تعليق الواجهة
- بطء شديد في التنقل
- عدم تحميل المنشأة حتى بعد تسجيل الدخول

## الحل
تعديل بسيط في `useEffect` داخل `TenantContext.tsx`:
- عندما لا يوجد مستخدم ولم يكن هناك مستخدم سابق → نضع `loading = false` (ننهي التحميل)
- بدلاً من ترك `loading = true` للأبد

## التغيير المطلوب

### الملف: `src/contexts/TenantContext.tsx`

**قبل (الكود الحالي المعيب):**
```typescript
} else {
  // Never had a user - just waiting for auth to initialize
  log('No user yet, waiting for auth...');
  // Keep loading = true (default state)
}
```

**بعد (الإصلاح):**
```typescript
} else {
  // Never had a user - no user logged in
  log('No user yet, setting loading to false');
  setLoading(false);
}
```

## لماذا هذا يحل المشكلة؟

| الحالة | السلوك الحالي (معيب) | السلوك بعد الإصلاح |
|--------|---------------------|-------------------|
| فتح `/auth` بدون تسجيل دخول | `loading = true` للأبد ❌ | `loading = false` ✅ |
| تسجيل الدخول | قد لا يتفاعل لأنه عالق | `user` يتغير → `fetchTenants()` ✅ |
| بعد تسجيل الدخول | المنشأة لا تظهر | المنشأة تظهر ✅ |

## الملفات المتأثرة
- `src/contexts/TenantContext.tsx` فقط (تعديل سطر واحد)

## القسم التقني

### السبب العميق
الكود كان يفترض أن "عدم وجود user + عدم وجود hadUser سابق = انتظر". لكن هذا خطأ لأن:
- على صفحة `/auth` لا يوجد user من البداية
- الانتظار للأبد يجمّد الواجهة

### الإصلاح الصحيح
"عدم وجود user + عدم وجود hadUser سابق = لا يوجد مستخدم مسجل → أنهِ التحميل"

هذا يحافظ على:
- التمييز بين "لم يسجل دخول بعد" و "سجل خروج" (عبر `hadUserRef`)
- تفاعل صحيح عند تسجيل الدخول (لأن `user` سيتغير ويُشغّل الـ effect)
